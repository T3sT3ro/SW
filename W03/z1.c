#include <avr/io.h>
#include <avr/pgmspace.h>
#include <stdint.h>
#include <util/delay.h>

#define PIN PD5
#define PORT_DDR DDRD
#define PORT PORTD
#define PIN_STATE(state) PORT = state ? PORT | _BV(PIN) : PORT & ~_BV(PIN)
#define BPM 210
#define MEASURE_1_32_MS \
    (1000 / BPM * 60 / 32 * 1000)  // ms duration for 1/32 note

typedef enum {
    T_C,
    T_CS,
    T_D,
    T_DS,
    T_E,
    T_F,
    T_FS,
    T_G,
    T_GS,
    T_A,
    T_AS,
    T_B,
    T_PAUSE
} TONE;
// A4 - 446 Hz
const uint16_t TONES[12] = {
    [T_C] = 1885,  [T_CS] = 1779, [T_D] = 1679, [T_DS] = 1585, [T_E] = 1496,
    [T_F] = 1412,  [T_FS] = 1333, [T_G] = 1258, [T_GS] = 1188, [T_A] = 1121,
    [T_AS] = 1058, [T_B] = 999};  // 1/2 * (10e6/Hz) -
                                  // on/off duration
typedef enum {
    D_1_32 = 0,
    D_1_16 = 1,
    D_1_8 = 2,
    D_1_4 = 3,
    D_1_2 = 4,
    D_1_1 = 5,
    D_2_1 = 6,
    D_4_1 = 7,
    D_8_1 = 8,
} DURATION;

typedef struct {
    TONE tone;
    DURATION duration;
    int8_t octave;  // range 0->8
} NOTE;

#define MUSIC_LEN 1191
const NOTE music[MUSIC_LEN] PROGMEM = {
    {T_A,D_1_8,5},{T_A,D_1_16,5},{T_A,D_1_32,5},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_C,D_1_32,6},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_C,D_1_2,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_B,D_1_2,5},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_PAUSE,D_1_32,0},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_FS,D_1_4,4},{T_FS,D_1_8,4},{T_FS,D_1_16,4},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_D,D_1_2,5},{T_D,D_1_4,5},{T_D,D_1_8,5},{T_PAUSE,D_1_32,0},{T_B,D_1_2,4},{T_B,D_1_4,4},{T_B,D_1_8,4},{T_PAUSE,D_1_32,0},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_D,D_1_2,5},{T_D,D_1_4,5},{T_D,D_1_8,5},{T_PAUSE,D_1_32,0},{T_B,D_1_2,4},{T_B,D_1_4,4},{T_B,D_1_8,4},{T_PAUSE,D_1_32,0},{T_FS,D_1_4,4},{T_FS,D_1_8,4},{T_FS,D_1_16,4},{T_FS,D_1_4,4},{T_FS,D_1_8,4},{T_FS,D_1_16,4},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_D,D_1_2,5},{T_D,D_1_4,5},{T_D,D_1_8,5},{T_PAUSE,D_1_32,0},{T_B,D_1_2,4},{T_B,D_1_4,4},{T_B,D_1_8,4},{T_PAUSE,D_1_32,0},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_D,D_1_2,5},{T_D,D_1_4,5},{T_D,D_1_8,5},{T_PAUSE,D_1_32,0},{T_B,D_1_2,4},{T_B,D_1_4,4},{T_B,D_1_8,4},{T_PAUSE,D_1_32,0},{T_FS,D_1_4,4},{T_FS,D_1_8,4},{T_FS,D_1_16,4},{T_FS,D_1_4,4},{T_FS,D_1_8,4},{T_FS,D_1_16,4},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_D,D_1_2,5},{T_D,D_1_4,5},{T_D,D_1_8,5},{T_PAUSE,D_1_32,0},{T_B,D_1_2,4},{T_B,D_1_4,4},{T_B,D_1_8,4},{T_PAUSE,D_1_32,0},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_D,D_1_2,5},{T_D,D_1_4,5},{T_D,D_1_8,5},{T_PAUSE,D_1_32,0},{T_B,D_1_2,4},{T_B,D_1_4,4},{T_B,D_1_8,4},{T_PAUSE,D_1_32,0},{T_FS,D_1_8,4},{T_FS,D_1_16,4},{T_FS,D_1_32,4},{T_FS,D_1_8,4},{T_FS,D_1_16,4},{T_FS,D_1_32,4},{T_FS,D_1_4,4},{T_FS,D_1_8,4},{T_FS,D_1_16,4},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_D,D_1_1,5},{T_D,D_1_4,5},{T_D,D_1_16,5},{T_PAUSE,D_1_16,0},{T_B,D_1_4,4},{T_B,D_1_8,4},{T_B,D_1_16,4},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_GS,D_1_2,4},{T_GS,D_1_4,4},{T_GS,D_1_16,4},{T_PAUSE,D_1_16,0},{T_PAUSE,D_1_32,0},{T_CS,D_1_2,5},{T_CS,D_1_4,5},{T_CS,D_1_8,5},{T_PAUSE,D_1_32,0},{T_F,D_1_8,4},{T_F,D_1_16,4},{T_F,D_1_32,4},{T_GS,D_1_8,4},{T_GS,D_1_16,4},{T_GS,D_1_32,4},{T_CS,D_1_8,5},{T_CS,D_1_16,5},{T_CS,D_1_32,5},{T_F,D_1_8,5},{T_F,D_1_16,5},{T_F,D_1_32,5},{T_GS,D_1_8,5},{T_GS,D_1_16,5},{T_GS,D_1_32,5},{T_CS,D_1_8,6},{T_CS,D_1_16,6},{T_CS,D_1_32,6},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_A,D_1_32,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_A,D_1_32,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_1,6},{T_F,D_1_4,6},{T_F,D_1_16,6},{T_PAUSE,D_1_16,0},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_PAUSE,D_1_32,0},{T_A,D_1_32,7},{T_G,D_1_32,7},{T_F,D_1_32,7},{T_E,D_1_32,7},{T_D,D_1_32,7},{T_C,D_1_32,7},{T_B,D_1_32,6},{T_A,D_1_32,6},{T_G,D_1_32,6},{T_F,D_1_32,6},{T_E,D_1_32,6},{T_D,D_1_32,6},{T_C,D_1_32,6},{T_B,D_1_16,5},{T_A,D_1_2,5},{T_A,D_1_8,5},{T_A,D_1_32,5},{T_PAUSE,D_1_32,0},{T_CS,D_1_4,6},{T_CS,D_1_8,6},{T_CS,D_1_16,6},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_GS,D_1_4,5},{T_GS,D_1_8,5},{T_GS,D_1_16,5},{T_FS,D_1_4,5},{T_FS,D_1_8,5},{T_FS,D_1_16,5},{T_GS,D_1_4,5},{T_GS,D_1_8,5},{T_GS,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_E,D_1_1,6},{T_E,D_1_4,6},{T_E,D_1_16,6},{T_PAUSE,D_1_16,0},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_CS,D_1_2,6},{T_CS,D_1_4,6},{T_CS,D_1_8,6},{T_PAUSE,D_1_32,0},{T_B,D_1_2,5},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_PAUSE,D_1_32,0},{T_FS,D_1_4,5},{T_FS,D_1_8,5},{T_FS,D_1_16,5},{T_GS,D_1_4,5},{T_GS,D_1_8,5},{T_GS,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_CS,D_1_4,6},{T_CS,D_1_8,6},{T_CS,D_1_16,6},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_GS,D_1_4,5},{T_GS,D_1_8,5},{T_GS,D_1_16,5},{T_E,D_1_4,5},{T_E,D_1_8,5},{T_E,D_1_16,5},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_FS,D_1_4,6},{T_FS,D_1_8,6},{T_FS,D_1_16,6},{T_E,D_1_2,6},{T_E,D_1_8,6},{T_E,D_1_32,6},{T_PAUSE,D_1_32,0},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_B,D_1_32,5},{T_CS,D_1_2,6},{T_CS,D_1_4,6},{T_CS,D_1_8,6},{T_PAUSE,D_1_32,0},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_A,D_1_32,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_B,D_1_32,5},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_C,D_1_32,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_D,D_1_32,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_E,D_1_8,6},{T_E,D_1_32,6},{T_D,D_1_4,6},{T_D,D_1_32,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_D,D_1_2,6},{T_D,D_1_8,6},{T_D,D_1_32,6},{T_PAUSE,D_1_32,0},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_G,D_1_32,6},{T_G,D_1_2,6},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_PAUSE,D_1_32,0},{T_D,D_1_2,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_D,D_1_1,6},{T_D,D_1_4,6},{T_D,D_1_16,6},{T_PAUSE,D_1_16,0},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_E,D_1_2,6},{T_E,D_1_16,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_16,6},{T_PAUSE,D_1_32,0},{T_E,D_1_2,6},{T_E,D_1_16,6},{T_PAUSE,D_1_32,0},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_B,D_1_8,5},{T_B,D_1_32,5},{T_C,D_1_2,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_C,D_1_32,6},{T_PAUSE,D_1_32,0},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_E,D_1_8,6},{T_E,D_1_32,6},{T_D,D_1_4,6},{T_D,D_1_32,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_PAUSE,D_1_4,0},{T_PAUSE,D_1_8,0},{T_PAUSE,D_1_16,0},{T_PAUSE,D_1_32,0},{T_G,D_1_2,6},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_PAUSE,D_1_32,0},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_G,D_1_1,6},{T_G,D_1_4,6},{T_G,D_1_16,6},{T_PAUSE,D_1_16,0},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_E,D_1_1,6},{T_E,D_1_4,6},{T_E,D_1_16,6},{T_PAUSE,D_1_16,0},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_D,D_1_32,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_E,D_1_32,6},{T_F,D_1_1,6},{T_F,D_1_4,6},{T_F,D_1_16,6},{T_PAUSE,D_1_16,0},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_D,D_1_32,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_F,D_1_32,6},{T_FS,D_1_4,6},{T_FS,D_1_8,6},{T_FS,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_FS,D_1_4,6},{T_FS,D_1_8,6},{T_FS,D_1_16,6},{T_A,D_1_4,6},{T_A,D_1_8,6},{T_A,D_1_16,6},{T_A,D_1_1,6},{T_A,D_1_4,6},{T_A,D_1_16,6},{T_PAUSE,D_1_16,0},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_GS,D_1_4,6},{T_E,D_1_4,6},{T_B,D_1_4,5},{T_GS,D_1_4,5},{T_E,D_1_4,5},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_C,D_1_1,6},{T_C,D_1_4,6},{T_C,D_1_16,6},{T_PAUSE,D_1_16,0},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_D,D_1_1,6},{T_D,D_1_4,6},{T_D,D_1_16,6},{T_PAUSE,D_1_16,0},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_F,D_1_1,6},{T_F,D_1_4,6},{T_F,D_1_16,6},{T_PAUSE,D_1_16,0},{T_E,D_1_4,6},{T_E,D_1_8,6},{T_E,D_1_16,6},{T_E,D_1_1,6},{T_E,D_1_4,6},{T_E,D_1_16,6},{T_PAUSE,D_1_16,0},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_C,D_1_1,6},{T_C,D_1_4,6},{T_C,D_1_16,6},{T_PAUSE,D_1_16,0},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_A,D_1_4,5},{T_A,D_1_8,5},{T_A,D_1_16,5},{T_A,D_1_1,5},{T_A,D_1_4,5},{T_A,D_1_16,5},{T_PAUSE,D_1_16,0},{T_G,D_1_4,5},{T_G,D_1_8,5},{T_G,D_1_16,5},{T_G,D_1_1,5},{T_G,D_1_4,5},{T_G,D_1_16,5},{T_PAUSE,D_1_16,0},{T_C,D_1_4,7},{T_C,D_1_8,7},{T_C,D_1_16,7},{T_C,D_1_4,7},{T_C,D_1_8,7},{T_C,D_1_16,7},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_A,D_1_4,6},{T_A,D_1_8,6},{T_A,D_1_16,6},{T_D,D_1_4,7},{T_D,D_1_8,7},{T_D,D_1_16,7},{T_D,D_1_4,7},{T_D,D_1_8,7},{T_D,D_1_16,7},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_B,D_1_4,6},{T_B,D_1_8,6},{T_B,D_1_16,6},{T_F,D_1_4,7},{T_F,D_1_8,7},{T_F,D_1_16,7},{T_F,D_1_1,7},{T_F,D_1_4,7},{T_F,D_1_16,7},{T_PAUSE,D_1_16,0},{T_E,D_1_4,7},{T_E,D_1_8,7},{T_E,D_1_16,7},{T_E,D_1_2,7},{T_E,D_1_4,7},{T_E,D_1_8,7},{T_PAUSE,D_1_2,0},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_C,D_1_1,6},{T_C,D_1_4,6},{T_C,D_1_16,6},{T_PAUSE,D_1_16,0},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_A,D_1_1,6},{T_A,D_1_4,6},{T_A,D_1_16,6},{T_PAUSE,D_1_16,0},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_D,D_1_32,7},{T_C,D_1_32,7},{T_B,D_1_32,6},{T_A,D_1_32,6},{T_G,D_1_32,6},{T_F,D_1_32,6},{T_E,D_1_32,6},{T_D,D_1_32,6},{T_C,D_1_32,6},{T_B,D_1_4,5},{T_B,D_1_8,5},{T_B,D_1_16,5},{T_DS,D_1_1,6},{T_DS,D_1_2,6},{T_DS,D_1_4,6},{T_PAUSE,D_1_16,0},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_F,D_1_1,6},{T_F,D_1_4,6},{T_F,D_1_16,6},{T_PAUSE,D_1_16,0},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_GS,D_1_1,6},{T_GS,D_1_4,6},{T_GS,D_1_16,6},{T_PAUSE,D_1_16,0},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_G,D_1_1,6},{T_G,D_1_4,6},{T_G,D_1_16,6},{T_PAUSE,D_1_16,0},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_1,6},{T_DS,D_1_4,6},{T_DS,D_1_16,6},{T_PAUSE,D_1_16,0},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_C,D_1_1,6},{T_C,D_1_4,6},{T_C,D_1_16,6},{T_PAUSE,D_1_16,0},{T_AS,D_1_4,5},{T_AS,D_1_8,5},{T_AS,D_1_16,5},{T_AS,D_1_1,5},{T_AS,D_1_4,5},{T_AS,D_1_16,5},{T_PAUSE,D_1_16,0},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_32,6},{T_G,D_1_8,5},{T_G,D_1_16,5},{T_G,D_1_32,5},{T_DS,D_1_8,5},{T_DS,D_1_16,5},{T_DS,D_1_32,5},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_32,6},{T_G,D_1_8,5},{T_G,D_1_16,5},{T_G,D_1_32,5},{T_DS,D_1_8,5},{T_DS,D_1_16,5},{T_DS,D_1_32,5},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_F,D_1_32,6},{T_AS,D_1_8,5},{T_AS,D_1_16,5},{T_AS,D_1_32,5},{T_F,D_1_8,5},{T_F,D_1_16,5},{T_F,D_1_32,5},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_F,D_1_32,6},{T_AS,D_1_8,5},{T_AS,D_1_16,5},{T_AS,D_1_32,5},{T_F,D_1_8,5},{T_F,D_1_16,5},{T_F,D_1_32,5},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_GS,D_1_32,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_32,6},{T_GS,D_1_8,5},{T_GS,D_1_16,5},{T_GS,D_1_32,5},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_GS,D_1_32,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_32,6},{T_GS,D_1_8,5},{T_GS,D_1_16,5},{T_GS,D_1_32,5},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_G,D_1_32,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_32,6},{T_G,D_1_8,5},{T_G,D_1_16,5},{T_G,D_1_32,5},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_G,D_1_32,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_32,6},{T_G,D_1_8,5},{T_G,D_1_16,5},{T_G,D_1_32,5},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_1,6},{T_DS,D_1_4,6},{T_DS,D_1_16,6},{T_PAUSE,D_1_16,0},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_AS,D_1_4,5},{T_AS,D_1_8,5},{T_AS,D_1_16,5},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_G,D_1_4,6},{T_G,D_1_8,6},{T_G,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_C,D_1_4,6},{T_C,D_1_8,6},{T_C,D_1_16,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_PAUSE,D_1_4,0},{T_PAUSE,D_1_8,0},{T_PAUSE,D_1_16,0},{T_PAUSE,D_1_32,0},{T_D,D_1_4,6},{T_D,D_1_8,6},{T_D,D_1_16,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_DS,D_1_32,6},{T_F,D_1_8,6},{T_F,D_1_16,6},{T_F,D_1_32,6},{T_FS,D_1_8,6},{T_FS,D_1_16,6},{T_FS,D_1_32,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_GS,D_1_32,6},{T_AS,D_1_4,6},{T_AS,D_1_8,6},{T_AS,D_1_16,6},{T_AS,D_1_4,6},{T_AS,D_1_8,6},{T_AS,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_B,D_1_4,6},{T_B,D_1_8,6},{T_B,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_AS,D_1_4,6},{T_AS,D_1_8,6},{T_AS,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_AS,D_1_4,6},{T_AS,D_1_8,6},{T_AS,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_B,D_1_4,6},{T_B,D_1_8,6},{T_B,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_AS,D_1_4,6},{T_AS,D_1_8,6},{T_AS,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_AS,D_1_4,6},{T_AS,D_1_8,6},{T_AS,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_B,D_1_4,6},{T_B,D_1_8,6},{T_B,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_GS,D_1_16,6},{T_DS,D_1_4,6},{T_DS,D_1_8,6},{T_DS,D_1_16,6},{T_AS,D_1_2,6},{T_AS,D_1_4,6},{T_AS,D_1_8,6},{T_PAUSE,D_1_32,0},{T_FS,D_1_2,6},{T_FS,D_1_4,6},{T_FS,D_1_8,6},{T_PAUSE,D_1_32,0},{T_GS,D_1_2,6},{T_GS,D_1_4,6},{T_GS,D_1_8,6},{T_PAUSE,D_1_32,0},{T_F,D_1_2,6},{T_F,D_1_4,6},{T_F,D_1_8,6},{T_PAUSE,D_1_32,0},{T_FS,D_1_4,6},{T_FS,D_1_8,6},{T_FS,D_1_16,6},{T_DS,D_1_2,6},{T_DS,D_1_1,6},{T_DS,D_1_2,6},{T_DS,D_1_32,6},{T_PAUSE,D_1_8,0},{T_PAUSE,D_1_16,0},{T_PAUSE,D_1_32,0},{T_FS,D_1_8,6},{T_FS,D_1_16,6},{T_FS,D_1_32,6},{T_AS,D_1_8,6},{T_AS,D_1_16,6},{T_AS,D_1_32,6},{T_DS,D_1_8,7},{T_DS,D_1_16,7},{T_DS,D_1_32,7},
};

void play(const NOTE* note) {
    // to play full note play 32= 1<<5 1/32 notes
    uint8_t repetitions = 1 << pgm_read_byte(&(note->duration));
    uint8_t played = 0;
    // duration in microseconds
    TONE tone = pgm_read_byte(&(note->tone));
    uint8_t octave = pgm_read_byte(&(note->octave));

    uint16_t delay = tone == T_PAUSE
                         ? 0
                         : octave >= 4 ? TONES[tone] >> (octave - 4)
                                       : TONES[tone] << -(octave - 4);

    // play x* 1/32 note at specific octave
    while (played < repetitions) {
        uint16_t ums = 0;  // counts the 1/32 note duration
        while (ums < MEASURE_1_32_MS) {
            if (tone == T_PAUSE) {
                ums++;
                _delay_us(1);
            };
            PIN_STATE(1);
            uint16_t ums_elapsed = 0;
            while (ums_elapsed < delay) {
                _delay_us(1);
                ums_elapsed++;
            }
            ums_elapsed = 0;
            PIN_STATE(0);
            while (ums_elapsed < delay) {
                _delay_us(1);
                ums_elapsed++;
            }
            ums += 2 * delay;
        }
        played++;
    }
}

int main() {
    PORT_DDR |= _BV(PIN);
    PIN_STATE(0);
    int16_t current_note = 0;
    while (1) {
        play(&music[current_note]);
        current_note = (current_note + 1) % MUSIC_LEN;
    }
}